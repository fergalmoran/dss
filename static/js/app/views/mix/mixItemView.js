// Generated by CoffeeScript 1.3.3
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['moment', 'app', 'marionette', 'models/comment/commentCollection', 'views/comment/commentListView', 'text!/tpl/MixListItemView'], function(moment, App, Marionette, CommentsCollection, CommentsListView, Template) {
    var MixItemView;
    MixItemView = (function(_super) {

      __extends(MixItemView, _super);

      function MixItemView() {
        this.renderComments = __bind(this.renderComments, this);

        this.renderGenres = __bind(this.renderGenres, this);

        this.startMix = __bind(this.startMix, this);

        this.onRender = __bind(this.onRender, this);

        this.initialize = __bind(this.initialize, this);
        return MixItemView.__super__.constructor.apply(this, arguments);
      }

      MixItemView.prototype.template = _.template(Template);

      MixItemView.prototype.tagName = MixItemView.tagName || "li";

      MixItemView.prototype.className = MixItemView.className || "";

      MixItemView.prototype.events = {
        "click .play-button-small-start": "startMix",
        "click .play-button-small-resume": "resumeMix",
        "click .play-button-small-pause": "pauseMix",
        "click .mix-link": "mixLink",
        "click .like-button a": "likeMix",
        "click .favourite-button a": "favouriteMix",
        "click .share-button": "shareMix",
        "click .download-button a": "downloadMix"
      };

      MixItemView.prototype.initialize = function() {
        this.listenTo(this.model, 'change:favourited', this.render);
        this.listenTo(this.model, 'change:liked', this.render);
        return true;
      };

      MixItemView.prototype.onRender = function() {
        var id, totalDuration, totalDurationText;
        id = this.model.get('id');
        if (this.model.get('duration')) {
          totalDuration = moment.duration(this.model.get('duration'), "seconds");
          totalDurationText = totalDuration.hours() !== 0 ? moment(totalDuration).format("HH:mm:ss") : moment(totalDuration).format("mm:ss");
          $('#player-duration-' + id, this.el).text(totalDurationText);
        }
        if (com.podnoms.player.isPlayingId(this.model.id)) {
          com.podnoms.settings.setupPlayer(this.model.toJSON());
        }
        this.renderGenres();
      };

      MixItemView.prototype.startMix = function() {
        var id;
        console.log("MixItemView: starting mix");
        id = this.model.get('id');
        $.getJSON("/ajax/mix_stream_url/" + id + "/", function(data) {
          com.podnoms.settings.setupPlayer(data, id);
          com.podnoms.player.startPlaying({
            success: function() {
              window._eventAggregator.trigger("track_playing");
              window._eventAggregator.trigger("track_changed", data);
              com.podnoms.utils.checkPlayCount();
            },
            error: function() {
              return com.podnoms.utils.showWarning("Ooops", "Error playing mix. If you have a flash blocker, please disable it for this site. Otherwise, do please try again.");
            }
          });
          return com.podnoms.storage.setItem("now_playing", id);
        });
      };

      MixItemView.prototype.pauseMix = function() {
        console.log("MixItemView: pauseMix");
        com.podnoms.player.pause();
        this.trigger("mix:paused", this.model);
        return true;
      };

      MixItemView.prototype.resumeMix = function() {
        console.log("MixItemView: resumeMix");
        com.podnoms.player.resume();
        this.trigger("mix:resumed", this.model);
        return true;
      };

      MixItemView.prototype.renderGenres = function() {
        var el;
        el = this.el;
        $.each(this.model.get("genre-list"), function(data) {
          $("#genre-list", el).append('<a href="/mixes/' + this.slug + '" class="dss-tag-button">' + this.text + '</a>');
          return true;
        });
        return true;
      };

      MixItemView.prototype.renderComments = function() {
        var comments;
        comments = new CommentsCollection();
        comments.url = this.model.get("resource_uri") + "comments/";
        comments.mix_id = this.model.id;
        comments.mix = this.model.get("resource_uri");
        comments.fetch({
          success: function(data) {
            var content;
            console.log(data);
            content = new CommentsListView({
              collection: comments
            }).render();
            $("#comments", this.el).html(content.el);
            return $('#mix-tab a:first', this.el).tab('show');
          }
        });
        return true;
      };

      MixItemView.prototype.favouriteMix = function() {
        var app;
        console.log("MixItemView: favouriteMix");
        app = require('app');
        app.vent.trigger("mix:favourite", this.model);
        return true;
      };

      MixItemView.prototype.likeMix = function() {
        var app;
        console.log("MixItemView: likeMix");
        app = require('app');
        app.vent.trigger("mix:like", this.model);
        return true;
      };

      MixItemView.prototype.shareMix = function(e) {
        var app, mode;
        console.log("MixItemView: shareMix");
        mode = $(e.currentTarget).data("mode");
        console.log("MixItemView: " + mode);
        app = require('app');
        app.vent.trigger("mix:share", mode, this.model);
        return true;
      };

      return MixItemView;

    })(Marionette.ItemView);
    return MixItemView;
  });

}).call(this);
